<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code æ™ºæ…§ç³»çµ± (3æ¬„Excelç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f0f2f5;
        }
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); padding: 10px; text-align: center; margin: 0; }
        
        header { 
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; position: relative;
        }
        
        h2 { color: #333; margin: 10px 0 20px 0; font-size: 1.5rem; width: 100%; }

        /* è¨­å®šæŒ‰éˆ• */
        .settings-icon {
            position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer;
            background: #fff; padding: 5px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
        }

        /* ç›¸æ©Ÿå€åŸŸ */
        #camera-wrapper {
            width: 100%; max-width: 500px; margin-bottom: 15px; display: none; position: relative;
        }
        #reader { width: 100%; border: 4px solid #333; border-radius: 8px; cursor: pointer; background: #000; }
        .camera-hint {
            position: absolute; bottom: 5px; left: 0; right: 0; color: white; background: rgba(0,0,0,0.6);
            padding: 5px; font-size: 12px; pointer-events: none;
        }
        #ocr-status { margin: 5px 0; color: #d63384; font-weight: bold; min-height: 20px; font-size: 0.9rem; }

        /* æŒ‰éˆ•æ¨£å¼ (RWD: æ‰‹æ©Ÿ2æ¬„ / é›»è…¦4æ¬„) */
        .btn-group { 
            display: grid; 
            gap: 8px; 
            width: 100%;
            max-width: 800px; 
            margin: 0 auto 20px auto;
            grid-template-columns: 1fr 1fr; /* æ‰‹æ©Ÿé è¨­ */
        }

        @media (min-width: 768px) {
            .btn-group { grid-template-columns: repeat(4, 1fr); }
        }
        
        button {
            width: 100%;
            padding: 10px 5px; 
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px; 
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.2;
            overflow: hidden;
            white-space: normal;
        }
        
        button span.icon { font-size: 20px; margin-bottom: 2px; display: block; }
        .btn-excel { font-size: 16px; } 

        .btn-scan { background-color: #007bff; }
        .btn-ocr { background-color: #ffc107; color: #333; }
        .btn-excel { background-color: #17a2b8; }
        .btn-clear { background-color: #dc3545; }
        button:active { transform: scale(0.98); }

        /* æ ¼ä½æ’ç‰ˆ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        .grid-item {
            background: white; padding: 10px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #e1e1e1;
            display: flex; flex-direction: column; align-items: center;
        }

        .grid-label { font-size: 12px; color: #888; margin-bottom: 5px; align-self: flex-start; }
        input {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
            box-sizing: border-box; margin-bottom: 5px; font-size: 16px;
        }

        /* æ¢ç¢¼é¡¯ç¤ºå€ */
        .code-display-area {
            width: 100%; height: 120px; background-color: #fff;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 5px; border: 1px dashed #ddd; cursor: pointer;
            overflow: hidden; position: relative;
        }
        .code-display-area img, .code-display-area svg { max-width: 95%; max-height: 95%; }
        
        .toggle-hint {
            position: absolute; top: 2px; right: 2px; font-size: 10px; color: #aaa; background: rgba(255,255,255,0.8);
        }

        .qr-text-info {
            font-size: 13px; color: #333; word-break: break-all;
            background: #eef; padding: 4px; border-radius: 4px; width: 100%; min-height: 18px;
        }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 85%; max-width: 400px; border-radius: 8px; text-align: left; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group input { width: 100%; padding: 8px; }

    </style>
</head>
<body>

    <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>

    <header>
        <h2 id="app-title">QR Code æ™ºæ…§ç³»çµ±</h2>
        
        <div id="camera-wrapper">
            <div id="reader"></div>
            <div class="camera-hint">ğŸ‘† é»æ“Šç•«é¢ï¼šæ‹ç…§ä¸¦ OCR æ–‡å­—è¾¨è­˜</div>
        </div>
        <div id="ocr-status"></div>

        <div class="btn-group">
            <button class="btn-scan" onclick="startQRScan()">
                <span class="icon">ğŸ“¸</span>æƒæ
            </button>
            <button class="btn-ocr" onclick="triggerOCRFile()">
                <span class="icon">ğŸ“„</span>åœ–ç‰‡ OCR
            </button>
            <button class="btn-excel" onclick="exportExcelWithImages()">
                <span class="icon">ğŸ“Š</span>åŒ¯å‡º EXCEL
            </button>
            <button class="btn-clear" onclick="clearAll()">
                <span class="icon">ğŸ—‘ï¸</span>æ¸…é™¤å…¨éƒ¨
            </button>
            <input type="file" id="ocr-file-input" style="display: none;" accept="image/*" onchange="processOCRFile(this)">
        </div>
    </header>

    <div class="grid-container" id="main-grid"></div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>ç³»çµ±è¨­å®š</h3>
            <div class="form-group">
                <label>ä¸»æ¨™é¡Œåç¨±ï¼š</label>
                <input type="text" id="set-title">
            </div>
            <div class="form-group">
                <label>QR Code æ ¼æ•¸è¨­å®šï¼š</label>
                <input type="number" id="set-count" min="1" max="100">
            </div>
            <div class="modal-footer">
                <button onclick="saveSettings()" style="background-color:#28a745; color:white; padding:8px 15px; border:none; border-radius:4px;">å„²å­˜</button>
                <button onclick="closeSettings()" style="background-color:#6c757d; color:white; padding:8px 15px; border:none; border-radius:4px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let appConfig = { title: "QR Code æ™ºæ…§ç³»çµ±", gridCount: 12, fontSize: 12 };
        let html5QrCode;
        let scanTimeout; 
        let codeModes = {}; 

        window.onload = function() { loadConfig(); initGrid(); };

        function initGrid() {
            const gridContainer = document.getElementById('main-grid');
            gridContainer.innerHTML = ""; 
            document.getElementById('app-title').innerText = appConfig.title;

            for (let i = 1; i <= appConfig.gridCount; i++) {
                if (!codeModes[i]) codeModes[i] = 'qr';
                let itemDiv = document.createElement('div');
                itemDiv.className = 'grid-item';

                let label = document.createElement('div');
                label.className = 'grid-label';
                label.innerText = 'æ ¼ä½ ' + i;

                let input = document.createElement('input');
                input.type = 'text';
                input.id = 'data-' + i;
                input.placeholder = 'å¾…è¼¸å…¥...';
                input.onkeyup = function() { generateSingleCode(i); };

                let codeDiv = document.createElement('div');
                codeDiv.id = 'code-container-' + i;
                codeDiv.className = 'code-display-area';
                codeDiv.onclick = function() { toggleCodeType(i); };
                
                let hint = document.createElement('span');
                hint.className = 'toggle-hint';
                hint.innerText = 'åˆ‡æ›';
                codeDiv.appendChild(hint);

                let imgContent = document.createElement('div');
                imgContent.id = 'code-img-' + i; 
                codeDiv.appendChild(imgContent);

                let textDiv = document.createElement('div');
                textDiv.id = 'text-info-' + i;
                textDiv.className = 'qr-text-info';

                itemDiv.appendChild(label);
                itemDiv.appendChild(input);
                itemDiv.appendChild(codeDiv);
                itemDiv.appendChild(textDiv);
                gridContainer.appendChild(itemDiv);
            }
        }

        function generateSingleCode(index) {
            let inputVal = document.getElementById('data-' + index).value.trim();
            let container = document.getElementById('code-img-' + index);
            let textContainer = document.getElementById('text-info-' + index);
            
            container.innerHTML = ""; 
            textContainer.innerText = inputVal;

            if (inputVal === "") { container.innerText = "(ç©º)"; return; }

            if (codeModes[index] === 'qr') {
                new QRCode(container, {
                    text: inputVal,
                    width: 100,
                    height: 100,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });
            } else {
                let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                container.appendChild(svg);
                try {
                    JsBarcode(svg, inputVal, { format: "CODE128", width: 2, height: 40, displayValue: false, margin: 0 });
                } catch (e) { container.innerText = "æ ¼å¼éŒ¯èª¤"; }
            }
        }

        function fillData(text) {
            let confirmMsg = "æƒæåˆ°çš„è³‡æ–™ï¼š\n\n" + text + "\n\nç¢ºå®šè¦å¡«å…¥å—ï¼Ÿ";
            if (!confirm(confirmMsg)) {
                return;
            }

            let parts = text.split(/[\n,]+/).filter(item => item.trim().length > 0);
            let filledCount = 0;
            for (let part of parts) {
                let placed = false;
                for (let i = 1; i <= appConfig.gridCount; i++) {
                    let input = document.getElementById('data-' + i);
                    if (input.value.trim() === "") {
                        input.value = part;
                        generateSingleCode(i);
                        placed = true;
                        filledCount++;
                        break;
                    }
                }
                if (!placed) {
                    alert("âš ï¸ æ¬„ä½å·²æ»¿ï¼è³‡æ–™ (" + part + ") ç„¡æ³•å¡«å…¥ã€‚");
                    return;
                }
            }
        }

        // --- é‡é»ä¿®æ”¹ï¼šExcel 3æ¬„ä½æ’ç‰ˆ ---
        async function exportExcelWithImages() {
            let hasData = false;
            for(let i=1; i<=appConfig.gridCount; i++){
                if(document.getElementById('data-'+i).value.trim() !== "") hasData = true;
            }
            if(!hasData) { alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼"); return; }

            const statusDiv = document.getElementById('ocr-status');
            statusDiv.innerText = "â³ æ­£åœ¨ç”¢ç”Ÿ 3æ¬„ Excel (å«åœ–ç‰‡)...";

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('QR Codes');

            // è¨­å®š 3 å€‹æ¬„ä½çš„å¯¬åº¦ (A, B, C)
            worksheet.columns = [
                { width: 25 }, { width: 25 }, { width: 25 }
            ];

            // è¡¨é ­
            worksheet.mergeCells('A1:C1');
            worksheet.getCell('A1').value = "QR Code è³‡æ–™æ¸…å–® (3æ¬„æ’åˆ—)";
            worksheet.getCell('A1').font = { bold: true, size: 14 };
            worksheet.getCell('A1').alignment = { horizontal: 'center' };
            
            let validItemIndex = 0; // ç”¨ä¾†è¨ˆç®—æ’åœ¨ç¬¬å¹¾å€‹ä½ç½®
            const COL_COUNT = 3;    // 3æ¬„æ¨¡å¼

            for (let i = 1; i <= appConfig.gridCount; i++) {
                let val = document.getElementById('data-' + i).value.trim();
                
                // åªæœ‰ç•¶æ ¼å­æœ‰è³‡æ–™æ™‚æ‰åŒ¯å‡º
                if (val !== "") {
                    // è¨ˆç®—ç›®å‰è³‡æ–™æ‡‰è©²åœ¨ç¬¬å¹¾æ¬„ (0, 1, 2)
                    let colIndex = validItemIndex % COL_COUNT; 
                    
                    // è¨ˆç®—ç›®å‰è³‡æ–™æ‡‰è©²åœ¨ç¬¬å¹¾çµ„åˆ— (0, 1, 2...)
                    // æ¯çµ„åˆ—åŒ…å«ï¼šåœ–ç‰‡åˆ— + æ–‡å­—åˆ—
                    let rowGroupIndex = Math.floor(validItemIndex / COL_COUNT);

                    // è½‰æ›æˆ Excel çš„å¯¦éš›åˆ—è™Ÿ (å¾ç¬¬2åˆ—é–‹å§‹æ˜¯è³‡æ–™å€)
                    // åœ–ç‰‡åˆ—ï¼š2, 4, 6...
                    // æ–‡å­—åˆ—ï¼š3, 5, 7...
                    let imgRowNumber = 2 + (rowGroupIndex * 2);
                    let textRowNumber = imgRowNumber + 1;

                    // è¨­å®šé«˜åº¦
                    worksheet.getRow(imgRowNumber).height = 100; // åœ–ç‰‡æ ¼é«˜åº¦
                    worksheet.getRow(textRowNumber).height = 30; // æ–‡å­—æ ¼é«˜åº¦

                    // --- è™•ç†åœ–ç‰‡ ---
                    let imgContainer = document.querySelector('#code-img-' + i + ' img');
                    let canvasContainer = document.querySelector('#code-img-' + i + ' canvas');
                    let base64Image = null;

                    if (imgContainer) {
                        base64Image = imgContainer.src;
                    } else if (canvasContainer) {
                        base64Image = canvasContainer.toDataURL();
                    }

                    // å–å¾—ç›®å‰çš„ Cell (åœ–ç‰‡æ”¾ç½®ä½ç½®)
                    // colIndex æ˜¯ 0,1,2ï¼Œå°æ‡‰ Excel æ¬„ä½æ˜¯ 1,2,3
                    // row æ˜¯ imgRowNumber (å› ç‚º addImage ä½¿ç”¨çš„æ˜¯ 0-based row indexï¼Œæ‰€ä»¥è¦æ¸› 1)
                    
                    if (base64Image && codeModes[i] === 'qr') {
                        const imageId = workbook.addImage({
                            base64: base64Image,
                            extension: 'png',
                        });
                        worksheet.addImage(imageId, {
                            tl: { col: colIndex, row: imgRowNumber - 1 }, // row ç‚º 0-based
                            ext: { width: 100, height: 100 },
                            editAs: 'oneCell'
                        });
                    } else {
                        // å¦‚æœæ˜¯æ¢ç¢¼æˆ–ç„¡åœ–ï¼Œé¡¯ç¤ºæ–‡å­—æ›¿ä»£
                        let cell = worksheet.getCell(imgRowNumber, colIndex + 1);
                        cell.value = "[æ¢ç¢¼/ç„¡åœ–]";
                        cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    }

                    // --- è™•ç†ä¸‹æ–¹æ–‡å­— ---
                    let textCell = worksheet.getCell(textRowNumber, colIndex + 1);
                    textCell.value = val;
                    textCell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    textCell.font = { size: 12, bold: true };

                    // ç•«æ¡†ç·š
                    let imgCell = worksheet.getCell(imgRowNumber, colIndex + 1);
                    imgCell.border = { top: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} };
                    textCell.border = { bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} };

                    validItemIndex++;
                }
            }

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            saveAs(blob, "QRCode_Data_3Columns.xlsx");
            
            statusDiv.innerText = "âœ… Excel ä¸‹è¼‰å®Œæˆï¼";
        }

        function toggleCodeType(index) {
            let current = codeModes[index];
            codeModes[index] = (current === 'qr') ? 'barcode' : 'qr';
            generateSingleCode(index);
        }

        function startQRScan() {
            const wrapper = document.getElementById('camera-wrapper');
            wrapper.style.display = "block";
            document.getElementById('ocr-status').innerText = "ç›¸æ©Ÿå•Ÿå‹•ä¸­... (10ç§’è‡ªå‹•é—œé–‰)";
            html5QrCode = new Html5Qrcode("reader");
            resetScanTimer();
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decodedText) => {
                    fillData(decodedText); 
                    resetScanTimer();
                }, () => {}
            ).then(() => {
                setTimeout(() => {
                    let videoElement = document.querySelector("#reader video");
                    if(videoElement) videoElement.onclick = function() { captureAndOCR(videoElement); };
                }, 1000);
            }).catch(err => { alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š" + err); wrapper.style.display = "none"; });
        }

        function stopScan() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('camera-wrapper').style.display = "none";
                    clearTimeout(scanTimeout);
                }).catch(err => console.log(err));
            }
        }
        function resetScanTimer() {
            if(scanTimeout) clearTimeout(scanTimeout);
            scanTimeout = setTimeout(() => { stopScan(); document.getElementById('ocr-status').innerText = "ğŸ’¤ ç›¸æ©Ÿé—œé–‰"; }, 10000);
        }

        function captureAndOCR(video) {
            let canvas = document.createElement("canvas");
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            document.getElementById('ocr-status').innerText = "â³ æ­£åœ¨è¾¨è­˜...";
            stopScan(); 
            Tesseract.recognize(canvas.toDataURL('image/png'), 'eng+chi_tra').then(({ data: { text } }) => {
                document.getElementById('ocr-status').innerText = "âœ… è¾¨è­˜å®Œæˆ";
                fillData(text.replace(/,/g, " "));
            });
        }
        function triggerOCRFile() { document.getElementById('ocr-file-input').click(); }
        function processOCRFile(input) {
            if (input.files && input.files[0]) {
                document.getElementById('ocr-status').innerText = "â³ è®€å–ä¸­...";
                Tesseract.recognize(input.files[0], 'eng+chi_tra').then(({ data: { text } }) => {
                    document.getElementById('ocr-status').innerText = "âœ… å®Œæˆ";
                    fillData(text.replace(/,/g, " "));
                });
            }
        }
        function clearAll() {
            if(!confirm("ç¢ºå®šæ¸…é™¤å…¨éƒ¨ï¼Ÿ")) return;
            for (let i = 1; i <= appConfig.gridCount; i++) {
                document.getElementById('data-' + i).value = "";
                generateSingleCode(i);
            }
        }
        function openSettings() {
            document.getElementById('set-title').value = appConfig.title;
            document.getElementById('set-count').value = appConfig.gridCount;
            document.getElementById('settingsModal').style.display = "block";
        }
        function closeSettings() { document.getElementById('settingsModal').style.display = "none"; }
        function saveSettings() {
            appConfig.title = document.getElementById('set-title').value;
            appConfig.gridCount = parseInt(document.getElementById('set-count').value) || 12;
            localStorage.setItem('qrAppConfig', JSON.stringify(appConfig));
            initGrid();
            closeSettings();
        }
        function loadConfig() {
            let saved = localStorage.getItem('qrAppConfig');
            if (saved) appConfig = JSON.parse(saved);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code / Barcode æ™ºæ…§ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f0f2f5;
        }
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); padding: 20px; text-align: center; }
        
        /* æ¨™é¡Œèˆ‡æ§åˆ¶å€ */
        header { margin-bottom: 20px; position: relative; }
        h2 { color: #333; margin-bottom: 15px; cursor: pointer; }

        /* è¨­å®šæŒ‰éˆ• (å³ä¸Šè§’) */
        .settings-icon {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 24px;
            cursor: pointer;
            background: #fff;
            padding: 5px 10px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* æƒæå™¨å€åŸŸ */
        #reader-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
            display: none;
        }
        #reader { width: 100%; border: 5px solid #333; cursor: pointer; }
        .camera-hint {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 5px;
            font-size: 12px;
            pointer-events: none;
        }
        #ocr-status { margin: 10px 0; color: #d63384; font-weight: bold; min-height: 24px;}

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            color: white;
            font-weight: bold;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-scan { background-color: #007bff; }
        .btn-ocr { background-color: #ffc107; color: #333; }
        .btn-excel { background-color: #17a2b8; }
        .btn-gen { background-color: #28a745; }
        .btn-clear { background-color: #dc3545; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* æ ¼ä½æ’ç‰ˆ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .grid-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #e1e1e1;
        }

        .grid-label { font-size: 14px; color: #888; margin-bottom: 5px; align-self: flex-start; }
        input {
            width: 100%; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; box-sizing: border-box; margin-bottom: 10px;
        }

        /* æ¢ç¢¼/QR é¡¯ç¤ºå€ */
        .code-display-area {
            width: 100%;
            height: 140px;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            border: 1px dashed #ddd; 
            cursor: pointer; /* æç¤ºå¯é»æ“Š */
            overflow: hidden;
            position: relative;
        }
        .code-display-area:hover { background-color: #f9f9f9; border-color: #bbb; }
        .code-display-area img, .code-display-area svg { max-width: 95%; max-height: 95%; }
        
        .toggle-hint {
            position: absolute; top: 2px; right: 2px; font-size: 10px; color: #aaa; background: rgba(255,255,255,0.8);
        }

        .qr-text-info {
            font-size: 14px; color: #333; word-break: break-all;
            background: #eef; padding: 5px; border-radius: 4px; width: 100%;
        }

        /* è¨­å®šè¦–çª— (Modal) */
        .modal {
            display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 400px; border-radius: 8px; text-align: left;
        }
        .modal-content h3 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; }
        .modal-footer { text-align: right; margin-top: 20px; }

    </style>
</head>
<body>

    <div class="settings-icon" onclick="openSettings()">âš™ï¸ è¨­å®š</div>

    <header>
        <h2 id="app-title">12æ ¼ QR Code ç”¢ç”Ÿèˆ‡æƒæå™¨</h2>
        
        <div class="btn-group">
            <button class="btn-scan" onclick="startQRScan()">ğŸ“¸ æƒæ (10ç§’è‡ªå‹•åœ)</button>
            <button class="btn-ocr" onclick="triggerOCRFile()">ğŸ“„ åœ–ç‰‡ OCR</button>
            <button class="btn-excel" onclick="exportExcel()">ğŸ“Š è½‰å‡º EXCEL</button>
            <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
            <input type="file" id="ocr-file-input" style="display: none;" accept="image/*" onchange="processOCRFile(this)">
        </div>
        
        <div id="ocr-status"></div>
        
        <div id="reader-container">
            <div id="reader" title="é»æ“Šç•«é¢é€²è¡Œæ‹ç…§è¾¨è­˜"></div>
            <div class="camera-hint">ğŸ‘† é»æ“Šç•«é¢ï¼šæ‹ç…§ä¸¦é€²è¡Œæ–‡å­—è¾¨è­˜</div>
        </div>
    </header>

    <div class="grid-container" id="main-grid">
        </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>ç³»çµ±è¨­å®š</h3>
            <div class="form-group">
                <label>ä¸»æ¨™é¡Œåç¨±ï¼š</label>
                <input type="text" id="set-title" value="12æ ¼ QR Code ç”¢ç”Ÿèˆ‡æƒæå™¨">
            </div>
            <div class="form-group">
                <label>QR Code æ ¼æ•¸è¨­å®šï¼š</label>
                <input type="number" id="set-count" value="12" min="1" max="100">
            </div>
            <div class="form-group">
                <label>Excel å­—é«”å¤§å° (åƒ…å½±éŸ¿é¡¯ç¤º/å‚™è¨»)ï¼š</label>
                <input type="number" id="set-font-size" value="12">
            </div>
            <div class="modal-footer">
                <button onclick="saveSettings()" class="btn-gen">ğŸ’¾ å„²å­˜ä¸¦é‡ç½®</button>
                <button onclick="closeSettings()" class="btn-clear">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
        let appConfig = {
            title: "12æ ¼ QR Code ç”¢ç”Ÿèˆ‡æƒæå™¨",
            gridCount: 12,
            fontSize: 12
        };
        
        let html5QrCode;
        let scanTimeout; // ç”¨æ–¼ 10 ç§’è‡ªå‹•åœæ­¢
        let codeModes = {}; // ç´€éŒ„æ¯ä¸€æ ¼ç›®å‰çš„æ¨¡å¼ 'qr' æˆ– 'barcode'

        // åˆå§‹åŒ–
        window.onload = function() {
            loadConfig();
            initGrid();
        };

        // --- 1. æ ¼ä½èˆ‡ä»‹é¢ç”Ÿæˆ ---
        function initGrid() {
            const gridContainer = document.getElementById('main-grid');
            gridContainer.innerHTML = ""; // æ¸…ç©º
            document.getElementById('app-title').innerText = appConfig.title;

            for (let i = 1; i <= appConfig.gridCount; i++) {
                // é è¨­æ¨¡å¼ç‚º QR
                if (!codeModes[i]) codeModes[i] = 'qr';

                let itemDiv = document.createElement('div');
                itemDiv.className = 'grid-item';

                let label = document.createElement('div');
                label.className = 'grid-label';
                label.innerText = 'æ ¼ä½ ' + i;

                let input = document.createElement('input');
                input.type = 'text';
                input.id = 'data-' + i;
                input.placeholder = 'è¼¸å…¥è³‡æ–™...';
                input.onkeyup = function() { generateSingleCode(i); };

                // é¡¯ç¤ºå€åŸŸ (QR æˆ– Barcode)
                let codeDiv = document.createElement('div');
                codeDiv.id = 'code-container-' + i;
                codeDiv.className = 'code-display-area';
                codeDiv.onclick = function() { toggleCodeType(i); }; // é»æ“Šåˆ‡æ›åŠŸèƒ½
                
                // æç¤ºæ–‡å­—
                let hint = document.createElement('span');
                hint.className = 'toggle-hint';
                hint.innerText = 'é»æ“Šåˆ‡æ›';
                codeDiv.appendChild(hint);

                // å…§å®¹å®¹å™¨ (img æˆ– svg)
                let imgContent = document.createElement('div');
                imgContent.id = 'code-img-' + i;
                codeDiv.appendChild(imgContent);

                // ä¸‹æ–¹æ–‡å­—
                let textDiv = document.createElement('div');
                textDiv.id = 'text-info-' + i;
                textDiv.className = 'qr-text-info';

                itemDiv.appendChild(label);
                itemDiv.appendChild(input);
                itemDiv.appendChild(codeDiv);
                itemDiv.appendChild(textDiv);
                gridContainer.appendChild(itemDiv);
            }
        }

        // --- 2. æ¢ç¢¼/QR ç”¢ç”Ÿé‚è¼¯ ---
        function generateSingleCode(index) {
            let inputVal = document.getElementById('data-' + index).value.trim();
            let container = document.getElementById('code-img-' + index);
            let textContainer = document.getElementById('text-info-' + index);
            
            container.innerHTML = ""; // æ¸…ç©º
            textContainer.innerText = inputVal;

            if (inputVal === "") {
                container.innerText = "(ç„¡è³‡æ–™)";
                return;
            }

            // ä¾æ“šç›®å‰æ¨¡å¼ç”¢ç”Ÿ
            if (codeModes[index] === 'qr') {
                // ç”¢ç”Ÿ QR Code
                new QRCode(container, {
                    text: inputVal,
                    width: 120,
                    height: 120,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });
            } else {
                // ç”¢ç”Ÿ Barcode
                let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                container.appendChild(svg);
                try {
                    JsBarcode(svg, inputVal, {
                        format: "CODE128",
                        width: 2,
                        height: 50,
                        displayValue: false // ä¸‹æ–¹å·²ç¶“æœ‰æ–‡å­—æ¡†äº†ï¼Œé€™è£¡ä¸é¡¯ç¤º
                    });
                } catch (e) {
                    container.innerText = "ç„¡æ³•ç”¢ç”Ÿæ¢ç¢¼(æ ¼å¼éŒ¯èª¤)";
                }
            }
        }

        // é»æ“Šåˆ‡æ› QR / Barcode
        function toggleCodeType(index) {
            let current = codeModes[index];
            codeModes[index] = (current === 'qr') ? 'barcode' : 'qr';
            generateSingleCode(index); // é‡æ–°ç”¢ç”Ÿ
        }

        // --- 3. ç›¸æ©Ÿèˆ‡æƒæé‚è¼¯ ---
        function startQRScan() {
            const readerDiv = document.getElementById('reader-container');
            readerDiv.style.display = "block";
            document.getElementById('ocr-status').innerText = "ç›¸æ©Ÿå·²å•Ÿå‹• - 10ç§’å¾Œè‡ªå‹•é—œé–‰";

            html5QrCode = new Html5Qrcode("reader");

            // é‡ç½®è¨ˆæ™‚å™¨
            resetScanTimer();

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    // æƒæåˆ° QR Code
                    console.log(`Scan result: ${decodedText}`);
                    fillData(decodedText);
                    stopScan();
                    alert("QR Code æƒææˆåŠŸï¼");
                },
                (errorMessage) => { 
                    // æƒæä¸­...ä¸å‹•ä½œ
                }
            ).then(() => {
                // ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸå¾Œï¼ŒåŠ å…¥é»æ“Šäº‹ä»¶ (é‡å° capture)
                // ç”±æ–¼ html5-qrcode å°è£äº† videoï¼Œæˆ‘å€‘éœ€è¦åŠ ä¸Šé»æ“Šç›£è½
                setTimeout(() => {
                    let videoElement = document.querySelector("#reader video");
                    if(videoElement) {
                        videoElement.onclick = function() {
                            captureAndOCR(videoElement);
                        };
                    }
                }, 1000); // å»¶é²ä¸€ä¸‹ç¢ºä¿ video å…ƒç´ å·²ç”Ÿæˆ
            }).catch(err => {
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š" + err);
            });
        }

        function stopScan() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader-container').style.display = "none";
                    clearTimeout(scanTimeout);
                    document.getElementById('ocr-status').innerText = "";
                }).catch(err => console.log(err));
            }
        }

        // 10ç§’è‡ªå‹•é—œé–‰é‚è¼¯
        function resetScanTimer() {
            if(scanTimeout) clearTimeout(scanTimeout);
            scanTimeout = setTimeout(() => {
                stopScan();
                document.getElementById('ocr-status').innerText = "ğŸ’¤ ç›¸æ©Ÿé–’ç½®è¶…é 10 ç§’ï¼Œå·²è‡ªå‹•é—œé–‰";
            }, 10000); // 10000 ms = 10 sec
        }

        // --- 4. é»æ“Šç•«é¢æ‹ç…§ OCR ---
        function captureAndOCR(video) {
            // è¦–è¦ºå›é¥‹
            video.style.opacity = "0.5";
            setTimeout(() => video.style.opacity = "1", 200);

            // 1. å»ºç«‹ Canvas æ“·å–ç•«é¢
            let canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 2. è½‰ç‚ºåœ–ç‰‡ä¸¦åŸ·è¡Œ OCR
            document.getElementById('ocr-status').innerText = "â³ æ­£åœ¨è¾¨è­˜å½±åƒæ–‡å­—...";
            
            // åœæ­¢ç›¸æ©Ÿ (æ¨¡æ“¬æ‹ç…§å®Œæˆ)
            stopScan(); 

            // åŸ·è¡Œ Tesseract
            Tesseract.recognize(
                canvas.toDataURL('image/png'),
                'eng+chi_tra',
                { logger: m => console.log(m) }
            ).then(({ data: { text } }) => {
                document.getElementById('ocr-status').innerText = "âœ… æ‹ç…§è¾¨è­˜å®Œæˆï¼";
                let cleanedText = text.replace(/,/g, " "); 
                fillData(cleanedText);
            });
        }

        function triggerOCRFile() {
            document.getElementById('ocr-file-input').click();
        }

        function processOCRFile(input) {
            if (input.files && input.files[0]) {
                document.getElementById('ocr-status').innerText = "â³ è®€å–åœ–ç‰‡ä¸­...";
                Tesseract.recognize(
                    input.files[0],
                    'eng+chi_tra'
                ).then(({ data: { text } }) => {
                    document.getElementById('ocr-status').innerText = "âœ… è¾¨è­˜å®Œæˆ";
                    let cleanedText = text.replace(/,/g, " ");
                    fillData(cleanedText);
                });
            }
        }

        // --- 5. è³‡æ–™å¡«å…… ---
        function fillData(text) {
            // ä½¿ç”¨ç©ºç™½ã€é€—è™Ÿã€æ›è¡Œåˆ‡å‰²
            let parts = text.split(/[\s,]+/).filter(item => item.length > 0);
            
            for (let i = 0; i < appConfig.gridCount; i++) {
                let inputField = document.getElementById('data-' + (i + 1));
                if (inputField) {
                    if (parts[i]) {
                        inputField.value = parts[i];
                    }
                    generateSingleCode(i + 1); // ç«‹å³æ›´æ–°åœ–ç¢¼
                }
            }
        }

        // --- 6. Excel åŒ¯å‡º ---
        function exportExcel() {
            let data = [];
            // è¡¨é ­
            data.push(["æ ¼ä½ç·¨è™Ÿ", "è³‡æ–™å…§å®¹", "å‚™è¨»"]);

            for (let i = 1; i <= appConfig.gridCount; i++) {
                let val = document.getElementById('data-' + i).value;
                data.push(["æ ¼ä½ " + i, val, ""]);
            }

            // å»ºç«‹å·¥ä½œè¡¨
            let ws = XLSX.utils.aoa_to_sheet(data);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "QR Data");

            // åŒ¯å‡º
            XLSX.writeFile(wb, "QRCode_Data.xlsx");
        }

        function clearAll() {
            for (let i = 1; i <= appConfig.gridCount; i++) {
                let input = document.getElementById('data-' + i);
                if(input) {
                    input.value = "";
                    generateSingleCode(i);
                }
            }
            document.getElementById('ocr-status').innerText = "";
        }

        // --- 7. è¨­å®šåŠŸèƒ½ ---
        function openSettings() {
            document.getElementById('set-title').value = appConfig.title;
            document.getElementById('set-count').value = appConfig.gridCount;
            document.getElementById('set-font-size').value = appConfig.fontSize;
            document.getElementById('settingsModal').style.display = "block";
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = "none";
        }

        function saveSettings() {
            appConfig.title = document.getElementById('set-title').value;
            let count = parseInt(document.getElementById('set-count').value);
            if(count > 0) appConfig.gridCount = count;
            appConfig.fontSize = document.getElementById('set-font-size').value;

            // å„²å­˜ä¸¦é‡ç¹ª
            localStorage.setItem('qrAppConfig', JSON.stringify(appConfig));
            initGrid();
            closeSettings();
        }

        function loadConfig() {
            let saved = localStorage.getItem('qrAppConfig');
            if (saved) {
                appConfig = JSON.parse(saved);
            }
        }
    </script>
</body>
</html>
